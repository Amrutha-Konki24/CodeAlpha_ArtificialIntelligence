<!DOCTYPE html>
<html>
<head>
  <title>Object Detection & Tracking</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { position: absolute; top: 0; left: 0; }
    video { position: absolute; top: 0; left: 0; }
  </style>
</head>

<body>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    let tracker = {};
    let nextID = 0;

    function iou(boxA, boxB) {
      const xA = Math.max(boxA[0], boxB[0]);
      const yA = Math.max(boxA[1], boxB[1]);
      const xB = Math.min(boxA[2], boxB[2]);
      const yB = Math.min(boxA[3], boxB[3]);

      const interArea = Math.max(0, xB - xA) * Math.max(0, yB - yA);
      const boxAArea = (boxA[2] - boxA[0]) * (boxA[3] - boxA[1]);
      const boxBArea = (boxB[2] - boxB[0]) * (boxB[3] - boxB[1]);

      return interArea / (boxAArea + boxBArea - interArea);
    }

    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      return new Promise(resolve => {
        video.onloadedmetadata = () => resolve(video);
      });
    }

    async function run() {
      await setupCamera();
      const model = await cocoSsd.load();

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      async function detect() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const predictions = await model.detect(video);

        predictions.forEach(pred => {
          if (pred.score > 0.5) {
            const [x, y, w, h] = pred.bbox;
            const box = [x, y, x + w, y + h];

            let assignedID = null;

            for (let id in tracker) {
              if (iou(tracker[id], box) > 0.3) {
                assignedID = id;
                break;
              }
            }

            if (assignedID === null) {
              assignedID = nextID++;
            }

            tracker[assignedID] = box;

            ctx.strokeStyle = "lime";
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);

            ctx.fillStyle = "lime";
            ctx.font = "16px Arial";
            ctx.fillText(
              `${pred.class} ID:${assignedID}`,
              x,
              y > 10 ? y - 5 : 10
            );
          }
        });

        requestAnimationFrame(detect);
      }

      detect();
    }

    run();
  </script>
</body>
</html>
